import{isPlainObject as w,isRedirect as F,isNotFound as A}from"@tanstack/react-router";import L from"tiny-invariant";import{AsyncLocalStorage as N}from"node:async_hooks";import{H3Event as x,getRequestURL as z,getRequestWebStream as H,getResponseStatus as P,eventHandler as I}from"h3";import{getContext as W}from"unctx";const J=[];function U(e){J.push(...e.middleware)}const c={stringify:e=>JSON.stringify(e,function(n,r){const o=this[n],i=y.find(f=>f.stringifyCondition(o));return i?i.stringify(o):r}),parse:e=>JSON.parse(e,function(n,r){const o=this[n];if(w(o)){const i=y.find(f=>f.parseCondition(o));if(i)return i.parse(o)}return r}),encode:e=>{if(Array.isArray(e))return e.map(n=>c.encode(n));if(w(e))return Object.fromEntries(Object.entries(e).map(([n,r])=>[n,c.encode(r)]));const t=y.find(n=>n.stringifyCondition(e));return t?t.stringify(e):e},decode:e=>{if(w(e)){const t=y.find(n=>n.parseCondition(e));if(t)return t.parse(e)}return Array.isArray(e)?e.map(t=>c.decode(t)):w(e)?Object.fromEntries(Object.entries(e).map(([t,n])=>[t,c.decode(n)])):e}},p=(e,t,n,r)=>({key:e,stringifyCondition:t,stringify:o=>({[`$${e}`]:n(o)}),parseCondition:o=>Object.hasOwn(o,`$${e}`),parse:o=>r(o[`$${e}`])}),y=[p("undefined",e=>e===void 0,()=>0,()=>{}),p("date",e=>e instanceof Date,e=>e.toISOString(),e=>new Date(e)),p("error",e=>e instanceof Error,e=>({...e,message:e.message,stack:void 0,cause:e.cause}),e=>Object.assign(new Error(e.message),e)),p("formData",e=>e instanceof FormData,e=>{const t={};return e.forEach((n,r)=>{const o=t[r];o!==void 0?Array.isArray(o)?o.push(n):t[r]=[o,n]:t[r]=n}),t},e=>{const t=new FormData;return Object.entries(e).forEach(([n,r])=>{Array.isArray(r)?r.forEach(o=>t.append(n,o)):t.append(n,r)}),t}),p("bigint",e=>typeof e=="bigint",e=>e.toString(),e=>BigInt(e))];function u(e,t){const n=t||e||{};return{options:n,middleware:r=>u(void 0,Object.assign(n,{middleware:r})),validator:r=>u(void 0,Object.assign(n,{validator:r})),client:r=>u(void 0,Object.assign(n,{client:r})),server:r=>u(void 0,Object.assign(n,{server:r}))}}function B(e){let t;const n=j(e),r={duplex:"half",method:e.method,headers:e.headers};return e.node.req.body instanceof ArrayBuffer?new Request(n,{...r,body:e.node.req.body}):new Request(n,{...r,get body(){return t||(t=X(e),t)}})}function G(e){return e.web??(e.web={request:B(e),url:j(e)}),e.web.request}function V(){return D()}const _=Symbol("$HTTPEvent");function K(e){return typeof e=="object"&&(e instanceof x||e?.[_]instanceof x||e?.__is_event__===!0)}function R(e){return function(...t){var n;const r=t[0];if(K(r))t[0]=r instanceof x||r.__is_event__?r:r[_];else{if(!((n=globalThis.app.config.server.experimental)!=null&&n.asyncContext))throw new Error("AsyncLocalStorage was not enabled. Use the `server.experimental.asyncContext: true` option in your app configuration to enable it. Or, pass the instance of HTTPEvent that you have as the first argument to the function.");t.unshift(V())}return e(...t)}}const j=R(z),Q=R(P),X=R(H);function Y(){var e;return W("nitro-app",{asyncContext:!!((e=globalThis.app.config.server.experimental)!=null&&e.asyncContext),AsyncLocalStorage:N})}function D(){const e=Y().use().event;if(!e)throw new Error("No HTTPEvent found in AsyncLocalStorage. Make sure you are using the function within the server runtime.");return e}const Z={},k=u().client(async e=>{const t=new Date;return e.next({context:{clientTime:t},sendContext:{clientTime:t}})}).server(async e=>{const t=new Date;return e.next({sendContext:{serverTime:t,durationToServer:t.getTime()-e.context.clientTime.getTime()}})}),ee=u().middleware([k]).client(async e=>{const t=await e.next(),n=new Date;return console.log("Client Req/Res:",{duration:t.context.clientTime.getTime()-n.getTime(),durationToServer:t.context.durationToServer,durationFromServer:n.getTime()-t.context.serverTime.getTime()}),t});U({middleware:[ee]});const fe=I(te),h=Z;async function te(e){const t=G(e);return await re({request:t,event:e})}function ne(e){return e.replace(/^\/|\/$/g,"")}async function re({request:e,event:t}){const n=new AbortController,r=n.signal,o=()=>n.abort();t.node.req.on("close",o);const i=e.method,f=new URL(e.url,"http://localhost:3000"),M=new RegExp(`${ne("/_server")}/([^/?#]+)`),C=f.pathname.match(M),d=C?C[1]:null,v=Object.fromEntries(f.searchParams.entries()),b="createServerFn"in v;if(typeof d!="string")throw new Error("Invalid server action param for serverFnId: "+d);const S=h[d];if(!S)throw console.log("serverFnManifest",h),new Error("Server function info not found for "+d);let g;if(g=await S.importer(),!g)throw console.log("serverFnManifest",h),new Error("Server function module not resolved for "+d);const l=g[S.functionName];if(!l)throw console.log("serverFnManifest",h),console.log("fnModule",g),new Error(`Server function module export not resolved for serverFn ID: ${d}`);const $=["multipart/form-data","application/x-www-form-urlencoded"],T=await(async()=>{try{let s=await(async()=>{if(e.headers.get("Content-Type")&&$.some(a=>{var O;return(O=e.headers.get("Content-Type"))==null?void 0:O.includes(a)}))return L(i.toLowerCase()!=="get","GET requests with FormData payloads are not supported"),await l(await e.formData(),r);if(i.toLowerCase()==="get"){let a=v;return b&&(a=v.payload),a=a&&c.parse(a),await l(a,r)}const m=await e.text(),E=c.parse(m);return b?await l(E,r):await l(...E,r)})();return s instanceof Response||!b&&(s=s.result,s instanceof Response)?s:F(s)||A(s)?q(s):new Response(s!==void 0?c.stringify(s):void 0,{status:Q(D()),headers:{"Content-Type":"application/json"}})}catch(s){return s instanceof Response?s:F(s)||A(s)?q(s):(console.info(),console.info("Server Fn Error!"),console.info(),console.error(s),console.info(),new Response(c.stringify(s),{status:500,headers:{"Content-Type":"application/json"}}))}})();if(t.node.req.removeListener("close",o),T.headers.get("Content-Type")==="application/json"){const m=await T.clone().text();m&&JSON.stringify(JSON.parse(m))}return T}function q(e){const{headers:t,...n}=e;return new Response(JSON.stringify(n),{status:200,headers:{"Content-Type":"application/json",...t||{}}})}export{fe as default};
